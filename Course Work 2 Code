# IMPORTS

import json
from datetime import datetime
import urllib.request
import urllib.error

# API FUNCTIONS

def fetch_weather_data(latitude, longitude):
    
# Fetch current weather data from API.

# Return parsed JSON data as a dictionary or None if error occurs.
    
    url = (
        f"https://api.open-meteo.com/v1/forecast?"
        f"latitude={latitude}&longitude={longitude}&current_weather=true"
    )

    try:
        with urllib.request.urlopen(url) as response:
            data = response.read()
            return json.loads(data)

# Error Handling

    except urllib.error.URLError:
        print("\n Network error: Could not reach the weather service.\n")
    except json.JSONDecodeError:
        print("\n Error: Received invalid JSON from API.\n")
    
    return None

# DATA PROCESSING

def extract_weather_info(weather_data):
    
    #Extracts temperature, windspeed, wind direction, and time from the API response.

    #Also calculates the "feels-like difference".
    
    try:
        current = weather_data["current_weather"]

        temperature = current["temperature"]
        windspeed = current["windspeed"]
        wind_direction = current["winddirection"]
        timestamp = current["time"]

        # Simple analysis: Difference in "feels-like" temperature due to wind
        feels_like_difference = round((windspeed * 0.1), 2)

        # Return extracted information as a dictionary

        return {
            "temperature": temperature,
            "windspeed": windspeed,
            "wind_direction": wind_direction,
            "timestamp": timestamp,
            "feels_like_difference": feels_like_difference
        }

# Error Handling

    except KeyError:
        print("\n Error: Missing expected data in API response.\n")
        return None

# REPORTING

def format_report(city, info):
    """Formats weather information into a readable string."""
    report = (
        f"--- Weather Report for {city} ---\n"
        f"Date/Time: {info['timestamp']}\n"
        f"Temperature: {info['temperature']}°C\n"
        f"Wind Speed: {info['windspeed']} km/h\n"
        f"Wind Direction: {info['wind_direction']}°\n"
        f"Feels-like Difference: +{info['feels_like_difference']}°C due to wind\n"
        f"Time Taken: {datetime.now()}\n"
        f"----------------------------------\n\n"
    )
    return report


def save_report(text, filename="report.txt"):

    # Appends the formatted summary to a report file.

    try:
        with open(filename, "a", encoding="utf-8") as file:
            file.write(text)
        print(f" Report saved to '{filename}'\n")

    # Error Handling

    except IOError:
        print("\n Error writing to report file.\n")

# MAIN PROGRAM LOOP

def main():
    print("Manchester Weather API Program")
    print("This program fetches current weather and saves the report on a .txt file\n")

    # Coordinates for Manchester

    city = "Manchester"
    latitude = 53.4808
    longitude = -2.2426

    # User loop for repeated weather data fetching

    while True:
        choice = input("Get latest weather? (y/n): ").strip().lower()

        if choice != "y":
            print("Goodbye!")
            break

        data = fetch_weather_data(latitude, longitude)
        if not data:
            continue

        info = extract_weather_info(data)
        if not info:
            continue

        # Generate and display report

        report_text = format_report(city, info)
        print("\n" + report_text)
        save_report(report_text)

# ENTRY POINT

if __name__ == "__main__":
    main()
